<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo.png">
    <title>JMS Transpose Live</title>
    <style>
        /* Original CSS unchanged */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            padding: 10px;
            margin: 0;
        }
        h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            font-size: 1.8em;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .accidentals-notes-chords {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .radio-button-group {
            display: flex;
            flex: 1;
            justify-content: space-between;
        }
        .radio-button {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.9em;
            border: 2px solid #3498db;
            background-color: white;
            color: #3498db;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .radio-button.selected {
            background-color: #3498db;
            color: white;
        }
        input[type="radio"] {
            display: none;
        }
        .note-group {
            display: inline-block;
            position: relative;
        }
        .dot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
            color: inherit;
        }
        .dot-above {
            top: -0.8em;
        }
        .dot-below {
            bottom: -0.6em;
        }
        .note-wrapper {
            display: inline-block;
            font-family: inherit;
        }
        .sharp {
            font-size: 0.8em;
            vertical-align: super;
        }
        .flat {
            font-size: 0.8em;
            vertical-align: sub;
        }
        #inputTextArea {
            width: 100%;
            min-height: 200px;
            max-height: 400px;
            font-family: monospace;
            font-size: 1.2em;
            border: 1px solid #bbb;
            padding: 12px;
            white-space: pre;
            word-wrap: break-word;
            overflow-y: auto;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            outline: none;
            transition: box-shadow 0.3s ease;
            vertical-align: baseline;
        }
        #inputTextArea sup, #inputTextArea sub {
            font-size: 0.75em;
            vertical-align: baseline;
            font-family: Arial, sans-serif;
            line-height: 1;
        }
        #inputTextArea:focus {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        label {
            font-weight: bold;
            font-size: 0.9em;
        }
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 8px;
            font-size: 0.9em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        button:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .accidentals, .mode-selection {
            margin: 20px 0;
            text-align: center;
        }
        .blue-notes {
            color: #1e90ff;
        }
        .red-chords {
            color: #e74c3c;
        }
        .sharp, .flat {
            font-size: 0.9em;
            vertical-align: super;
        }
        .octave {
            font-size: 0.9em;
            vertical-align: sub;
        }
        .controls button, .controls input {
            flex: 1;
            min-width: 70px;
            margin: 0 5px;
        }
        .print-controls, .title-controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .print-controls div, .title-controls div {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .print-controls label, .title-controls label {
            font-weight: bold;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .print-controls input, .title-controls input {
            flex: 1;
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
        }
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            .accidentals-notes-chords {
                flex-direction: row;
                justify-content: space-between;
            }
            .radio-button {
                font-size: 0.8em;
                padding: 6px;
            }
            .controls {
                flex-direction: row;
                align-items: center;
                justify-content: center;
            }
            .controls button {
                flex: 1;
                min-width: 70px;
            }
            .print-controls, .title-controls {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 10px;
            }
            .print-controls div, .title-controls div {
                flex: 1;
                min-width: 150px;
            }
            .print-controls label, .title-controls label {
                margin-right: 5px;
            }
            .print-controls input, .title-controls input {
                width: calc(100% - 120px);
            }
            .controls input {
                width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Accidentals and Mode in one line -->
        <div class="accidentals-notes-chords">
            <div class="radio-button-group">
                <label class="radio-button" data-accidental="sharp">Sharps
                    <input type="radio" name="accidental" value="sharp" checked>
                </label>
                <label class="radio-button" data-accidental="flat">Flats
                    <input type="radio" name="accidental" value="flat">
                </label>
            </div>
            <div class="radio-button-group">
                <label class="radio-button" data-mode="notes">Notes
                    <input type="radio" name="mode" value="notes" checked>
                </label>
                <label class="radio-button" data-mode="chords">Chords
                    <input type="radio" name="mode" value="chords">
                </label>
            </div>
        </div>

        <!-- Transpose buttons, Semitone display, and Reset button -->
        <div class="controls">
            <button id="transposeMinus">-</button>
            <input type="number" id="semitoneValue" value="0" min="-12" max="12" readonly>
            <button id="transposePlus">+</button>
            <button id="resetButton">Reset</button>
        </div>

        <!-- Text Area -->
        <div id="inputTextArea" contenteditable="false" placeholder="Enter notes or chords here..." style="font-family: monospace; white-space: pre; border: 1px solid black; padding: 10px; width: 100%; height: 300px;"></div>

        <!-- Title input -->
        <div class="title-controls">
            <label for="username">Title:</label>
            <input type="text" id="username" placeholder="Enter Title">
        </div>

        <!-- Key and Time inputs on the same line -->
        <div class="print-controls">
            <div>
                <label for="key">Key:</label>
                <input type="text" id="key" placeholder="Enter Key">
            </div>
            <div>
                <label for="time">Time:</label>
                <input type="text" id="time" placeholder="Enter Time Signature">
            </div>
        </div>

        <!-- Print button, Save & Export, and Import buttons on the same line -->
        <div class="controls">
            <button id="printBtn">Print</button>
            <button id="saveBtn">Save</button>
            <button id="importBtn">Open</button>
            <input type="file" id="importFile" style="display: none;">
        </div>
    </div>
  
    <script>
        const inputTextArea = document.getElementById('inputTextArea');
        const semitoneValue = document.getElementById('semitoneValue');
        const transposeMinus = document.getElementById('transposeMinus');
        const transposePlus = document.getElementById('transposePlus');
        const resetButton = document.getElementById('resetButton');
        const accidentals = document.getElementsByName('accidental');
        const modes = document.getElementsByName('mode');
        const printBtn = document.getElementById('printBtn');
        const saveBtn = document.getElementById('saveBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const nameInput = document.getElementById('username');
        const keyInput = document.getElementById('key');
        const timeInput = document.getElementById('time');

        let semitones = 0;
        let originalText = '';
        let originalKey = '';
        let accidentalPreference = 'sharp';
        let modePreference = 'notes';

        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        function transposeNote(note, shift) {
            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            const index = sharpNotes.indexOf(note) !== -1 ? sharpNotes.indexOf(note) : flatNotes.indexOf(note);
            if (index === -1) return note;

            const transposedIndex = (index + shift + 12) % 12;
            return notes[transposedIndex];
        }

        function transposeText(text, shift) {
            return text.replace(/([A-G][#b]*)([\(\)\[\]]?)(maj7|m7|m|M|dim|aug|sus2|sus4|add9|7|6|9|11|13)?/g, (match, note, octave, extension) => {
                return transposeNote(note, shift) + (octave || '') + (extension || '');
            });
        }

        function applyAccidentalPreference(text) {
            return text.replace(/([A-G][#b]*)([\(\)\[\]]?)(maj7|m7|m|M|dim|aug|sus2|sus4|add9|7|6|9|11|13)?/g, (match, note, octave, extension) => {
                const index = sharpNotes.indexOf(note) !== -1 ? sharpNotes.indexOf(note) : flatNotes.indexOf(note);
                if (index === -1) return match;

                const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
                return notes[index] + (octave || '') + (extension || '');
            });
        }

        function applyColorAndDots(text) {
            text = text.replace(/<([^>]+)>/g, '<span class="section-label">$1</span>');
            return text.replace(
                /([A-G])([#b]?)(['.]?)(maj7|m7|m|M|dim|aug|sus2|sus4|add9|7|6|9|11|13)?/g,
                (match, note, accidental, sign, extension) => {
                    const colorClass = modePreference === 'notes' ? 'blue-notes' : 'red-chords';
                    let formattedNote = `<span class="note-wrapper">${note}`;
                    if (accidental === '#') {
                        formattedNote += `<span class="sharp">#</span>`;
                    } else if (accidental === 'b') {
                        formattedNote += `<span class="flat">b</span>`;
                    }
                    formattedNote += `</span>`;
                    return `<span class="${colorClass} note-group">${formattedNote}${sign.replace("+", "'").replace("-", ".")}${extension ? `<span class="${colorClass}">${extension}</span>` : ''}</span>`;
                }
            );
        }

        function formatText(text) {
            if (modePreference === 'chords' || !text.trim()) {
                return applyColorAndDots(text).replace(/\n/g, '<br>');
            }

            const lines = text.split('\n');
            const formattedLines = [];
            const tableData = [];
            let maxCols = 0;
            lines.forEach(line => {
                if (line.trim() && line.includes('|')) {
                    const cols = line.split('|').map(col => col.trim());
                    maxCols = Math.max(maxCols, cols.length);
                    tableData.push(cols);
                }
            });

            tableData.forEach(row => {
                while (row.length < maxCols) {
                    row.push('');
                }
            });

            const colWidths = new Array(maxCols).fill(0);
            tableData.forEach(row => {
                row.forEach((col, i) => {
                    colWidths[i] = Math.max(colWidths[i], col.length);
                });
            });

            let tableRowIndex = 0;
            lines.forEach(line => {
                if (!line.trim() || !line.includes('|')) {
                    formattedLines.push(applyColorAndDots(line).replace(/\n/g, '<br>'));
                    return;
                }

                const cols = tableData[tableRowIndex];
                const formattedRow = cols.map((col, i) => {
                    const paddedCol = col.padEnd(colWidths[i], ' ');
                    return `<span class='table-cell' style='display: inline-block; width: ${colWidths[i] * 10}px'>${applyColorAndDots(paddedCol)}</span>`;
                }).join('<span class="table-separator">|</span>');

                formattedLines.push(formattedRow);
                tableRowIndex++;
            });

            return formattedLines.join('<br>');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const inputTextArea = document.getElementById('inputTextArea');
            let isEditing = false;

            inputTextArea.addEventListener('click', function() {
                if (!isEditing) {
                    isEditing = true;
                    inputTextArea.contentEditable = 'true';
                    inputTextArea.focus();
                }
            });

            inputTextArea.addEventListener('input', function() {
                originalText = inputTextArea.innerText;
            });

            document.addEventListener('click', function(event) {
                if (isEditing && !inputTextArea.contains(event.target)) {
                    isEditing = false;
                    inputTextArea.contentEditable = 'false';
                }
            });
        });

        const style = document.createElement('style');
        style.innerHTML = `
            .table-cell {
                text-align: center;
                padding: 0 10px;
                white-space: pre;
            }
            .table-separator {
                display: inline-block;
                font-weight: bold;
                padding: 0 5px;
            }
            .blue-notes { color: blue; }
            .red-chords { color: red; }
            .dot { font-size: 0.8em; font-weight: bold; color: inherit; position: relative; }
            .dot-above { top: -0.8em; }
            .dot-below { bottom: -0.8em; }
            .sharp, .flat { font-size: 0.8em; vertical-align: super; }
            .section-label { font-weight: bold; }
            #inputTextArea {
                font-family: monospace;
                white-space: pre;
            }
        `;
        document.head.appendChild(style);

        function updateTransposition() {
            let currentText = transposeText(originalText, semitones);
            currentText = applyAccidentalPreference(currentText);
            inputTextArea.innerHTML = formatText(currentText);
            placeCaretAtEnd(inputTextArea);

            let currentKey = transposeText(originalKey, semitones);
            currentKey = applyAccidentalPreference(currentKey);
            keyInput.value = currentKey;
        }

        function placeCaretAtEnd(el) {
            el.focus();
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        function handleTransposeClick(direction) {
            let newSemitones = semitones;
            if (direction === 'minus' && semitones > -12) {
                newSemitones--;
            } else if (direction === 'plus' && semitones < 12) {
                newSemitones++;
            } else {
                return;
            }

            semitones = newSemitones;
            semitoneValue.value = semitones;
            updateTransposition();
        }

        function reset() {
            semitones = 0;
            semitoneValue.value = 0;
            inputTextArea.innerHTML = formatText(originalText);
            keyInput.value = originalKey;
            updateTransposition();
        }

        function handleInputChange() {
            if (semitones === 0) {
                originalText = inputTextArea.innerText;
            } else {
                const currentText = inputTextArea.innerText;
                originalText = transposeText(currentText, -semitones);
            }
        }

        function handleKeyInputChange() {
            if (semitones === 0) {
                originalKey = keyInput.value;
            } else {
                const currentKey = keyInput.value;
                originalKey = transposeText(currentKey, -semitones);
            }
        }

        function printOutput() {
            const name = document.getElementById('username').value.trim();
            const key = document.getElementById('key').value.trim();
            const keySignature = document.getElementById('time').value.trim();
            const outputContent = document.getElementById('inputTextArea').innerHTML;

            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>Print Output</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('@page { size: A4; margin: 1cm; }');
            printWindow.document.write('body { font-weight: bold; font-family: monospace; white-space: pre; }');
            printWindow.document.write('.blue-notes { color: blue; }');
            printWindow.document.write('.red-chords { color: red; }');
            printWindow.document.write('.sharp { font-size: 0.8em; vertical-align: super; }');
            printWindow.document.write('.flat { font-size: 0.8em; vertical-align: super; }');
            printWindow.document.write('.dot { font-size: 0.8em; font-weight: bold; color: inherit; position: relative; display: inline-block; line-height: 1; }');
            printWindow.document.write('.dot-above, .dot-below { position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; line-height: 1; }');
            printWindow.document.write('.dot-above { top: -1em; }');
            printWindow.document.write('.dot-below { bottom: -1em; }');
            printWindow.document.write('.table-cell { text-align: center; display: inline-block; padding: 0 10px; white-space: nowrap; position: relative; vertical-align: middle; line-height: 1; }');
            printWindow.document.write('.table-separator { display: inline-block; font-weight: bold; padding: 0 5px; }');
            printWindow.document.write('.section-label { font-weight: bold; }');
            printWindow.document.write('.content-container { padding: 1cm; white-space: pre; margin: 0; box-sizing: border-box; text-align: justify; line-height: 1.4; }');
            printWindow.document.write('.header, .footer { text-align: center; font-size: 0.8em; position: fixed; width: 100%; background-color: white; box-sizing: border-box; }');
            printWindow.document.write('.header { top: 0; padding: 5px 0; border-bottom: 1px solid black; font-size: 1em; }');
            printWindow.document.write('.footer { bottom: 0; padding: 5px 0; border-top: 1px solid black; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<div class="header">Sing to Him a new song; Play skillfully with a shout of joy. Psalm 33:3</div>');
            printWindow.document.write('<div class="content-container">');
            printWindow.document.write(`<h1 style="text-align: center; margin-top: 0;">${name} - ${key} - ${keySignature}</h1>`);
            printWindow.document.write('<hr style="border: none; border-bottom: 2px solid black; margin: 10px 0;">');
            printWindow.document.write(outputContent);
            printWindow.document.write('</div>');
            printWindow.document.write('<div class="footer">created using johnmusicstudios.github.io/transposelive/</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function saveAndExport() {
            const name = document.getElementById('username').value.trim();
            const key = document.getElementById('key').value.trim();
            const keySignature = document.getElementById('time').value.trim();
            const outputContent = document.getElementById('inputTextArea').innerHTML;

            const state = {
                title: name,
                key: key,
                timeSignature: keySignature,
                content: outputContent,
                accidentalPreference,
                modePreference,
                semitones: 0 // Always save with semitones set to 0
            };

            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const fileName = `${name}-${key}-${keySignature}.json`;

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importState(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const state = JSON.parse(e.target.result);

                // Restore input fields with saved values
                document.getElementById('username').value = state.title || '';
                document.getElementById('key').value = state.key || '';
                document.getElementById('time').value = state.timeSignature || '';
                inputTextArea.innerHTML = state.content || '';

                // Set originalText and originalKey to the imported content
                originalText = inputTextArea.innerText || '';
                originalKey = state.key || '';

                // Reset semitones to 0
                semitones = 0;
                semitoneValue.value = 0;

                // Restore preferences
                accidentalPreference = state.accidentalPreference || 'sharp';
                modePreference = state.modePreference || 'notes';

                // Update UI states for buttons
                document.querySelector(`input[name="accidental"][value="${accidentalPreference}"]`).checked = true;
                document.querySelector(`input[name="mode"][value="${modePreference}"]`).checked = true;

                // Update display without applying transposition
                setInitialSelected();
                updateTransposition(); // Since semitones = 0, this will just apply formatting
            };
            reader.readAsText(file);
        }

        saveBtn.addEventListener('click', saveAndExport);
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', importState);

        printBtn.addEventListener('click', printOutput);

        transposeMinus.addEventListener('click', () => handleTransposeClick('minus'));
        transposePlus.addEventListener('click', () => handleTransposeClick('plus'));
        resetButton.addEventListener('click', reset);

        accidentals.forEach(radio => {
            radio.addEventListener('change', () => {
                accidentalPreference = document.querySelector('input[name="accidental"]:checked').value;
                updateTransposition();
            });
        });

        modes.forEach(radio => {
            radio.addEventListener('change', () => {
                modePreference = document.querySelector('input[name="mode"]:checked').value;
                updateTransposition();
            });
        });

        inputTextArea.addEventListener('input', handleInputChange);
        keyInput.addEventListener('input', handleKeyInputChange);

        function setInitialSelected() {
            const accidentalRadios = document.querySelectorAll('.radio-button-group input[name="accidental"]');
            accidentalRadios.forEach(radio => {
                radio.parentElement.classList.toggle('selected', radio.checked);
            });

            const modeRadios = document.querySelectorAll('.radio-button-group input[name="mode"]');
            modeRadios.forEach(radio => {
                radio.parentElement.classList.toggle('selected', radio.checked);
            });
        }

        const accidentalRadios = document.querySelectorAll('.radio-button-group input[name="accidental"]');
        accidentalRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                accidentalRadios.forEach(r => r.parentElement.classList.remove('selected'));
                this.parentElement.classList.add('selected');
            });
        });

        const modeRadios = document.querySelectorAll('.radio-button-group input[name="mode"]');
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                modeRadios.forEach(r => r.parentElement.classList.remove('selected'));
                this.parentElement.classList.add('selected');
            });
        });

        setInitialSelected();

        document.getElementById('inputTextArea').addEventListener('keypress', function(event) {
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            
            if (range.startContainer.nodeType === Node.ELEMENT_NODE) {
                const parentElement = range.startContainer.parentNode;
                if (parentElement.tagName.toLowerCase() === 'sup' || parentElement.tagName.toLowerCase() === 'sub') {
                    event.preventDefault();
                    range.setStartAfter(parentElement);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        });

        window.onload = () => {
            originalText = inputTextArea.innerText;
            originalKey = keyInput.value;
            updateTransposition();
        };

        function insertTextAtCaret(text) {
            const textArea = document.getElementById('inputTextArea');
            textArea.focus();
            
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            
            if (range.startContainer.nodeType === Node.ELEMENT_NODE) {
                const element = range.startContainer.parentElement;
                if (element.tagName.toLowerCase() === 'sup' || element.tagName.toLowerCase() === 'sub') {
                    range.setStartAfter(element);
                    range.collapse(true);
                }
            }
            
            range.deleteContents();
            range.insertNode(document.createTextNode(text));
            
            range.setStartAfter(range.endContainer);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }

        document.getElementById('inputTextArea').addEventListener('keydown', function(event) {
            // Prevent default behavior if necessary
        });

        document.getElementById('inputTextArea').addEventListener('keyup', function(event) {
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            const node = range.startContainer;

            if (node.nodeType === Node.ELEMENT_NODE) {
                const parent = node.closest('.sup, .sub');
                if (parent) {
                    const newRange = document.createRange();
                    newRange.setStartAfter(parent);
                    newRange.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(newRange);
                }
            }
        });

        document.getElementById('inputTextArea').addEventListener('click', function(event) {
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            const node = range.startContainer;

            if (node.nodeType === Node.ELEMENT_NODE) {
                const parent = node.closest('.sup, .sub');
                if (parent) {
                    const newRange = document.createRange();
                    newRange.setStartAfter(parent);
                    newRange.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(newRange);
                }
            }
        });
    </script>
</body>
</html>
