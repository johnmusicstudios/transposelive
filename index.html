<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JMS Chord Chart Editor</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --light-gray: #bdc3c7;
            --bg-color: #f4f4f9;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--secondary-color);
            margin: 0;
            padding: 5px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        h1 {
            font-family: 'Georgia', serif;
            font-size: 1.5em;
            text-align: center;
            margin: 0;
        }
        .controls-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .radio-button-group {
            display: flex;
            flex: 1;
            gap: 5px;
        }
        .radio-button {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-size: 0.85em;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            transition: background .2s, color .2s;
            user-select: none;
        }
        .radio-button.selected {
            background: var(--primary-color);
            color: white;
        }
        input[type="radio"] { display: none; }

        .controls { display: flex; gap: 10px; }
        .controls button, .controls input { flex: 1; }

        /* --- UPDATED: Button Grid Styles --- */
        #note-buttons-container, #chord-buttons-container {
            display: grid;
            gap: 5px;
        }
        #note-buttons-container {
            grid-template-columns: repeat(6, 1fr); /* 6x2 grid for notes */
        }
        #chord-buttons-container {
            grid-template-columns: repeat(5, 1fr); /* 5x2 grid for chords */
        }
        .note-btn, .chord-btn {
            background: #fff;
            color: var(--secondary-color);
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            padding: 8px 5px; /* Adjusted padding */
            font-family: monospace;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }
        .note-btn:hover, .chord-btn:hover { background: #ecf0f1; }

        #inputTextArea {
            width: 100%;
            min-height: 250px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
            border: 1px solid var(--light-gray);
            padding: 12px;
            border-radius: 6px;
            outline: none;
            box-sizing: border-box;
            background: #fff;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        .music-unit {
            display: inline;
            white-space: nowrap;
            user-select: none;
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 1em;
        }
        button {
            background: var(--primary-color);
            color: white;
            padding: 10px;
            font-size: 0.95em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background .2s;
        }
        button:hover { opacity: 0.9; }

        .blue-notes { color: #1e90ff; font-weight: bold; }
        .red-chords { color: #e74c3c; font-weight: bold; }
        .sharp, .flat { font-size: 0.75em; vertical-align: super; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chord Chart Editor</h1>
        <div class="controls-row">
            <div class="radio-button-group" role="radiogroup" aria-label="Accidentals">
                <label class="radio-button selected"><input type="radio" name="accidental" value="sharp" checked />Sharps (#)</label>
                <label class="radio-button"><input type="radio" name="accidental" value="flat" />Flats (b)</label>
            </div>
            <div class="radio-button-group" role="radiogroup" aria-label="Mode">
                <label class="radio-button selected"><input type="radio" name="insertionMode" value="notes" checked />Note</label>
                <label class="radio-button"><input type="radio" name="insertionMode" value="chords" />Chord</label>
            </div>
        </div>
        <div class="controls">
            <button id="transposeMinus">-</button>
            <input type="text" id="semitoneValue" value="0" readonly style="text-align:center; font-weight: bold;" />
            <button id="transposePlus">+</button>
            <button id="resetButton">Reset</button>
        </div>
        
        <div id="note-buttons-container"></div>
        <div id="chord-buttons-container"></div>

        <div id="inputTextArea" contenteditable="true" spellcheck="false"></div>

    </div>
    <script>
        const inputTextArea = document.getElementById('inputTextArea');
        const semitoneValue = document.getElementById('semitoneValue');
        const noteButtonsContainer = document.getElementById('note-buttons-container');
        const chordButtonsContainer = document.getElementById('chord-buttons-container');

        let semitones = 0;
        let accidentalPreference = 'sharp';
        let insertionMode = 'notes';

        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes  = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const chordExtensions = ['m', 'maj7', 'm7', '7', 'dim', 'aug', 'sus4', 'sus2', '6', '9'];

        function noteIndex(note) {
            return sharpNotes.indexOf(note) !== -1 ? sharpNotes.indexOf(note) : flatNotes.indexOf(note);
        }

        function transposeNote(note, shift) {
            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            const idx = noteIndex(note);
            if (idx === -1) return note;
            return notes[(idx + shift + 12) % 12];
        }
        
        function updateTransposition() {
            semitoneValue.value = semitones;
            inputTextArea.querySelectorAll('.music-unit').forEach(unit => {
                const originalNote = unit.dataset.originalNote;
                const originalExtension = unit.dataset.originalExtension || '';
                if (originalNote) {
                    const transposedNote = transposeNote(originalNote, semitones);
                    unit.innerHTML = formatNoteForDisplay(transposedNote) + originalExtension;
                }
            });
        }
        
        function formatNoteForDisplay(note) {
            if (note.length > 1) {
                const accidental = note.slice(1);
                const accidentalClass = accidental === '#' ? 'sharp' : 'flat';
                return `${note.charAt(0)}<span class="${accidentalClass}">${accidental}</span>`;
            }
            return note;
        }
        
        function renderNoteButtons() {
            noteButtonsContainer.innerHTML = '';
            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            notes.forEach(note => {
                const btn = document.createElement('button');
                btn.className = 'note-btn';
                btn.innerHTML = formatNoteForDisplay(note);
                btn.dataset.note = note;
                noteButtonsContainer.appendChild(btn);
            });
        }

        function renderChordButtons() {
            chordButtonsContainer.innerHTML = '';
            chordExtensions.forEach(ext => {
                const btn = document.createElement('button');
                btn.className = 'chord-btn';
                btn.textContent = ext;
                btn.dataset.ext = ext;
                chordButtonsContainer.appendChild(btn);
            });
        }
        
        function insertMusicUnit(note) {
            inputTextArea.focus();
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            range.deleteContents();

            const colorClass = insertionMode === 'notes' ? 'blue-notes' : 'red-chords';
            const unitSpan = document.createElement('span');
            unitSpan.className = `music-unit ${colorClass}`;
            unitSpan.dataset.originalNote = note;
            unitSpan.dataset.originalExtension = '';
            unitSpan.contentEditable = false;
            unitSpan.innerHTML = formatNoteForDisplay(note);

            range.insertNode(unitSpan);
            range.setStartAfter(unitSpan);
            range.collapse(true);
            
            selection.removeAllRanges();
            selection.addRange(range);
        }

        document.getElementById('transposeMinus').addEventListener('click', () => { if (semitones > -12) semitones--; updateTransposition(); });
        document.getElementById('transposePlus').addEventListener('click', () => { if (semitones < 12) semitones++; updateTransposition(); });
        document.getElementById('resetButton').addEventListener('click', () => { semitones = 0; updateTransposition(); });

        noteButtonsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.note-btn');
            if (btn) insertMusicUnit(btn.dataset.note);
        });
        
        chordButtonsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.chord-btn');
            if (!btn) return;
            
            const ext = btn.dataset.ext;
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.anchorNode) return;

            let node = selection.anchorNode;
            let offset = selection.anchorOffset;
            let precedingNode = (node.nodeType === Node.TEXT_NODE && offset > 0) ? node.previousSibling : node.childNodes[offset - 1];
            let lastUnit = (precedingNode && precedingNode.nodeType === Node.ELEMENT_NODE) ? precedingNode.closest('.music-unit') : null;
            
            if (lastUnit) {
                const note = lastUnit.dataset.originalNote;
                const newExt = (lastUnit.dataset.originalExtension || '') + ext;
                
                lastUnit.classList.remove('blue-notes');
                lastUnit.classList.add('red-chords');
                
                lastUnit.dataset.originalExtension = newExt;
                const transposedNote = transposeNote(note, semitones);
                lastUnit.innerHTML = formatNoteForDisplay(transposedNote) + newExt;

                inputTextArea.focus(); // KEYBOARD FIX: Refocus the editor
            }
        });

        document.querySelectorAll('input[name="accidental"]').forEach(radio =>
            radio.addEventListener('change', (e) => {
                accidentalPreference = e.target.value;
                document.querySelectorAll('input[name="accidental"]').forEach(r => r.parentElement.classList.remove('selected'));
                e.target.parentElement.classList.add('selected');
                renderNoteButtons();
                updateTransposition();
            })
        );

        document.querySelectorAll('input[name="insertionMode"]').forEach(radio =>
            radio.addEventListener('change', (e) => {
                insertionMode = e.target.value;
                document.querySelectorAll('input[name="insertionMode"]').forEach(r => r.parentElement.classList.remove('selected'));
                e.target.parentElement.classList.add('selected');
            })
        );

        // KEYBOARD FIX: Prevents keyboard collapse on double space
        inputTextArea.addEventListener('keydown', (e) => {
            if (e.key === ' ' && window.getSelection().anchorNode.textContent.slice(window.getSelection().anchorOffset - 1, window.getSelection().anchorOffset) === ' ') {
                e.preventDefault();
                document.execCommand('insertText', false, ' ');
            }
        });

        window.onload = () => {
            renderNoteButtons();
            renderChordButtons();
        };
    </script>
</body>
</html>
