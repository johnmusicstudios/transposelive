<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content" />
    <title>JMS Chord Chart Editor</title>
    <style>
        :root {
            --primary-color: #2c698d;
            --secondary-color: #333;
            --light-gray: #ccc;
            --bg-color: #f8f8f8;
            --toolbar-bg: #eef2f5;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--secondary-color);
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
            padding: 10px;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        h1 {
            font-family: 'Georgia', serif;
            font-size: 1.5em;
            text-align: center;
            margin: 0 0 10px 0;
            flex-shrink: 0;
            color: var(--primary-color);
            transition: all 0.2s ease-in-out;
        }
        #inputTextArea {
            flex-grow: 1;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
            border: 1px solid var(--light-gray);
            padding: 12px;
            border-radius: 6px;
            outline: none;
            box-sizing: border-box;
            background: #fff;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            overflow-y: auto;
            resize: none;
        }
        
        .toolbar {
            flex-shrink: 0;
            background: var(--toolbar-bg);
            border-top: 1px solid var(--light-gray);
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        .controls { display: flex; gap: 5px; }
        .controls button, .controls input { flex: 1; }
        .transpose-controls { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 5px; }
        
        button {
            background: var(--primary-color);
            color: white;
            padding: 8px;
            font-size: 1.1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #addMusicBtn {
            grid-column: 1 / -1;
            font-weight: bold;
            padding: 12px;
        }
        .music-unit { display: inline; white-space: nowrap; user-select: none; }
        .blue-notes { color: var(--primary-color); font-weight: bold; }
        .red-chords { color: #dc3545; font-weight: bold; }
        .sharp, .flat { font-size: 0.75em; vertical-align: super; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: var(--bg-color); border-radius: 8px; padding: 15px;
            width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: var(--secondary-color); }
        #closePaletteBtn { background: none; border: none; font-size: 1.8em; color: var(--light-gray); padding: 0; line-height: 1; }
        .radio-button-group { display: flex; flex: 1; gap: 5px; }
        .radio-button { flex: 1; text-align: center; padding: 8px; font-size: 1.1em; font-weight: bold; border: 1px solid var(--light-gray); background: #fff; color: var(--secondary-color); border-radius: 5px; cursor: pointer; user-select: none; }
        .radio-button.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        input[type="radio"] { display: none; }
        #palette-note-buttons { display: grid; gap: 5px; grid-template-columns: repeat(6, 1fr); }
        #palette-chord-buttons { display: grid; gap: 5px; grid-template-columns: repeat(5, 1fr); }
        .palette-btn { background: #fff; color: var(--secondary-color); border: 1px solid var(--light-gray); border-radius: 5px; padding: 10px 5px; font-family: monospace; font-size: 1em; font-weight: bold; cursor: pointer; text-align: center; }
        .palette-btn.selected { background: var(--primary-color); color: white; }
        .modal-footer { display: flex; gap: 10px; align-items: center; }
        #previewDisplay {
            flex-grow: 1; background: #fff; border: 1px solid var(--light-gray);
            border-radius: 5px; padding: 10px; text-align: center; font-family: monospace;
            font-weight: bold; font-size: 1.2em; min-height: 1.5em;
        }
        #insertBtn { font-weight: bold; }
        .icon { width: 1.1em; height: 1.1em; fill: currentColor; }

        /* --- NEW: Focus Mode Styles --- */
        body.keyboard-visible h1 {
            height: 0;
            margin: 0;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    
    <div class="main-content">
        <h1>Chord Chart Editor</h1>
        <div id="inputTextArea" contenteditable="true" spellcheck="false" autocorrect="off" autocapitalize="off"></div>
    </div>

    <div class="toolbar">
        <div class="controls">
            <button id="viewModeBtn" title="View Mode"><svg class="icon" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 0 12c2.73 4.39 7 7.5 12 7.5s9.27-3.11 12-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill-opacity="0.54"/></svg></button>
            <button id="editModeBtn" class="active" title="Edit Mode"><svg class="icon" viewBox="0 0 24 24"><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg></button>
        </div>
        <div class="controls transpose-controls">
            <button id="transposeMinus" title="Transpose Down">-</button>
            <input type="text" id="semitoneValue" value="0" readonly />
            <button id="transposePlus" title="Transpose Up">+</button>
        </div>
        <div class="controls">
            <button id="saveBtn" title="Save"><svg class="icon" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
            <button id="openBtn" title="Open"><svg class="icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg></button>
            <input type="file" id="fileInput" accept=".jms" style="display: none;" />
        </div>
        <button id="addMusicBtn" title="Add Note or Chord">+ Add Music</button>
    </div>

    <div id="paletteModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Music Palette</h3>
                <button id="closePaletteBtn" title="Close">&times;</button>
            </div>
            <div class="radio-button-group" role="radiogroup" aria-label="Accidentals">
                <label class="radio-button selected" title="Sharps"><input type="radio" name="paletteAccidental" value="sharp" checked />#</label>
                <label class="radio-button" title="Flats"><input type="radio" name="paletteAccidental" value="flat" />â™­</label>
            </div>
            <div id="palette-note-buttons"></div>
            <div id="palette-chord-buttons"></div>
            <div class="modal-footer">
                <div id="previewDisplay"></div>
                <button id="insertBtn">Insert</button>
            </div>
        </div>
    </div>


    <script>
        // --- Element References ---
        const body = document.body;
        const inputTextArea = document.getElementById('inputTextArea');
        const semitoneValue = document.getElementById('semitoneValue');
        const saveBtn = document.getElementById('saveBtn');
        const openBtn = document.getElementById('openBtn');
        const fileInput = document.getElementById('fileInput');
        const viewModeBtn = document.getElementById('viewModeBtn');
        const editModeBtn = document.getElementById('editModeBtn');
        const addMusicBtn = document.getElementById('addMusicBtn');
        const paletteModal = document.getElementById('paletteModal');
        const closePaletteBtn = document.getElementById('closePaletteBtn');
        const paletteNoteButtons = document.getElementById('palette-note-buttons');
        const paletteChordButtons = document.getElementById('palette-chord-buttons');
        const previewDisplay = document.getElementById('previewDisplay');
        const insertBtn = document.getElementById('insertBtn');

        // --- State Variables ---
        let semitones = 0;
        let accidentalPreference = 'sharp';
        let paletteRootNote = '';
        let paletteExtension = '';
        let initialWindowHeight = window.innerHeight;
        
        // --- Data ---
        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes  = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const chordExtensions = ['m', 'maj7', 'm7', '7', 'dim', 'aug', 'sus4', 'sus2', '6', '9'];

        // --- Core Logic ---
        function noteIndex(note) { return sharpNotes.indexOf(note) !== -1 ? sharpNotes.indexOf(note) : flatNotes.indexOf(note); }
        function transposeNote(note, shift) {
            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            const idx = noteIndex(note);
            if (idx === -1) return note;
            return notes[(idx + shift + 12) % 12];
        }
        function updateTransposition() {
            semitoneValue.value = semitones;
            inputTextArea.querySelectorAll('.music-unit').forEach(unit => {
                const originalNote = unit.dataset.originalNote;
                const originalExtension = unit.dataset.originalExtension || '';
                if (originalNote) {
                    const transposedNote = transposeNote(originalNote, semitones);
                    unit.innerHTML = formatNoteForDisplay(transposedNote) + originalExtension;
                }
            });
        }
        function formatNoteForDisplay(note) {
            if (note.length > 1) {
                const accidental = note.slice(1);
                const accidentalClass = accidental === '#' ? 'sharp' : 'flat';
                return `${note.charAt(0)}<span class="${accidentalClass}">${accidental}</span>`;
            } return note;
        }
        
        // --- UI Rendering ---
        function renderPaletteNoteButtons() {
            paletteNoteButtons.innerHTML = '';
            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            notes.forEach(note => {
                const btn = document.createElement('button');
                btn.className = 'palette-btn';
                btn.innerHTML = formatNoteForDisplay(note);
                btn.dataset.note = note;
                paletteNoteButtons.appendChild(btn);
            });
        }
        function renderPaletteChordButtons() {
            paletteChordButtons.innerHTML = '';
            chordExtensions.forEach(ext => {
                const btn = document.createElement('button');
                btn.className = 'palette-btn';
                btn.textContent = ext;
                btn.dataset.ext = ext;
                paletteChordButtons.appendChild(btn);
            });
        }
        
        // --- Editor Actions ---
        function insertMusicUnit(note, extension) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const colorClass = extension ? 'red-chords' : 'blue-notes';
            const unitSpan = document.createElement('span');
            unitSpan.className = `music-unit ${colorClass}`;
            unitSpan.dataset.originalNote = note;
            unitSpan.dataset.originalExtension = extension;
            unitSpan.contentEditable = false;
            unitSpan.innerHTML = formatNoteForDisplay(note) + extension;
            range.insertNode(unitSpan);
            range.setStartAfter(unitSpan);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            unitSpan.scrollIntoView({ block: 'center' });
        }

        function updatePreview() {
            if (!paletteRootNote) {
                previewDisplay.innerHTML = ''; return;
            }
            previewDisplay.innerHTML = formatNoteForDisplay(paletteRootNote) + paletteExtension;
        }
        
        // --- Event Listeners ---
        document.getElementById('transposeMinus').addEventListener('click', () => { if (semitones > -12) semitones--; updateTransposition(); });
        document.getElementById('transposePlus').addEventListener('click', () => { if (semitones < 12) semitones++; updateTransposition(); });
        
        addMusicBtn.addEventListener('click', () => { paletteModal.classList.remove('hidden'); });
        closePaletteBtn.addEventListener('click', () => { paletteModal.classList.add('hidden'); });
        paletteModal.addEventListener('click', (e) => { if (e.target === paletteModal) paletteModal.classList.add('hidden'); });

        document.querySelectorAll('input[name="paletteAccidental"]').forEach(radio =>
            radio.addEventListener('change', (e) => {
                accidentalPreference = e.target.value;
                e.target.closest('.radio-button-group').querySelectorAll('.radio-button').forEach(r => r.classList.remove('selected'));
                e.target.parentElement.classList.add('selected');
                renderPaletteNoteButtons();
                updateTransposition();
            })
        );
        
        paletteNoteButtons.addEventListener('click', e => {
            const btn = e.target.closest('.palette-btn');
            if (!btn) return;
            paletteRootNote = btn.dataset.note;
            paletteExtension = '';
            paletteNoteButtons.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            paletteChordButtons.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('selected'));
            updatePreview();
        });

        paletteChordButtons.addEventListener('click', e => {
            const btn = e.target.closest('.palette-btn');
            if (!btn || !paletteRootNote) return;
            paletteExtension += btn.dataset.ext;
            btn.classList.toggle('selected');
            updatePreview();
        });

        insertBtn.addEventListener('click', () => {
            if (paletteRootNote) {
                const transposedRoot = transposeNote(paletteRootNote, semitones);
                insertMusicUnit(transposedRoot, paletteExtension);
            }
            paletteRootNote = '';
            paletteExtension = '';
            updatePreview();
            paletteModal.classList.add('hidden');
        });

        inputTextArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textToInsert = (e.key === 'Enter') ? '\n' : ' ';
                const textNode = document.createTextNode(textToInsert);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        });

        saveBtn.addEventListener('click', () => {
            const filename = prompt("Enter a name for your song:", "my-song.jms");
            if (!filename) return;
            const state = { contentHTML: inputTextArea.innerHTML, semitones: semitones };
            const fileContent = JSON.stringify(state, null, 2);
            const blob = new Blob([fileContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.endsWith('.jms') ? filename : filename + '.jms';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        openBtn.addEventListener('click', () => { fileInput.click(); });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const state = JSON.parse(event.target.result);
                    inputTextArea.innerHTML = state.contentHTML || '';
                    semitones = state.semitones || 0;
                    semitoneValue.value = semitones;
                } catch (err) { alert("Error: Could not open the file."); }
            };
            reader.readAsText(file);
            e.target.value = null;
        });

        viewModeBtn.addEventListener('click', () => { addMusicBtn.style.display = 'none'; });
        editModeBtn.addEventListener('click', () => { addMusicBtn.style.display = 'flex'; });
        
        // --- NEW: Focus Mode to hide title when keyboard is up ---
        function handleKeyboardVisibility() {
            if (!window.visualViewport) return;
            // A common heuristic: if viewport is less than 85% of window, keyboard is likely open
            if (window.visualViewport.height < initialWindowHeight * 0.85) {
                body.classList.add('keyboard-visible');
            } else {
                body.classList.remove('keyboard-visible');
            }
        }

        // --- Initial Setup ---
        window.onload = () => {
            renderPaletteNoteButtons();
            renderPaletteChordButtons();
            if (window.visualViewport) {
                initialWindowHeight = window.visualViewport.height;
                window.visualViewport.addEventListener('resize', handleKeyboardVisibility);
            }
        };
    </script>
</body>
</html>
