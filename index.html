<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content" />
    <title>JMS Chord Chart Editor</title>
    <style>
        :root {
            --primary-color: #2c698d;
            --secondary-color: #333;
            --light-gray: #ccc;
            --bg-color: #f8f8f8;
            --toolbar-bg: #eef2f5;
            --high-octave-color: hotpink;
            --low-octave-color: orange;
        }
        html, body {
            height: 100%; margin: 0; overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--secondary-color);
            display: flex; flex-direction: column;
        }
        .main-content {
            flex-grow: 1; padding: 10px; padding-bottom: 0;
            display: flex; flex-direction: column; min-height: 0;
        }
        h1 {
            font-family: 'Georgia', serif; font-size: 1.5em; text-align: center;
            margin: 0 0 10px 0; flex-shrink: 0; color: var(--primary-color);
            transition: all 0.2s ease-in-out;
        }
        #inputTextArea {
            flex-grow: 1; width: 100%; 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 1.1em; border: 1px solid var(--light-gray); padding: 12px;
            border-radius: 6px; outline: none; box-sizing: border-box; background: #fff;
            line-height: 1.8;
            white-space: pre;
            overflow-wrap: break-word;
            overflow-y: auto; resize: none;
        }
        
        .toolbar {
            flex-shrink: 0; background: var(--toolbar-bg); border-top: 1px solid var(--light-gray);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        .contextual-controls { padding: 8px; }
        .context-panel { display: none; flex-direction: column; gap: 8px; }
        .context-panel.active { display: flex; }

        .button-scroll-wrapper { overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .button-scroll-wrapper::-webkit-scrollbar { display: none; }
        .button-row { display: flex; flex-wrap: nowrap; gap: 5px; padding-bottom: 5px; }
        .note-btn, .chord-btn {
            flex-shrink: 0; min-width: 50px; background: #fff; color: var(--secondary-color);
            border: 1px solid var(--light-gray); border-radius: 5px; padding: 8px 5px;
            font-family: monospace; font-size: 1em; font-weight: bold; cursor: pointer; text-align: center;
        }
        
        .main-nav {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px;
            background-color: var(--light-gray); border-top: 1px solid var(--light-gray);
        }
        .nav-btn {
            background-color: #fdfdfd; border: none; border-radius: 0; padding: 10px 5px;
            font-size: 0.9em; font-weight: bold; color: var(--secondary-color);
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .nav-btn.active { background-color: var(--primary-color); color: white; }

        .tool-row {
            display: flex;
            gap: 5px;
            align-items: stretch;
        }
        .tool-row > * {
            flex: 1; 
            min-width: 0;
        }

        .radio-button {
            text-align: center; padding: 8px; font-size: 1.1em; font-weight: bold;
            border: 1px solid var(--light-gray); background: #fff; color: var(--secondary-color);
            border-radius: 5px; cursor: pointer; user-select: none;
            display: flex; align-items: center; justify-content: center;
        }
        .radio-button.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        input[type="radio"] { display: none; }

        .music-unit {
            display: inline-block;
            white-space: nowrap; 
            margin: 0;
        }
        
        .bar-line {
            display: inline-block;
        }

        .blue-notes { color: var(--primary-color); font-weight: bold; }
        .red-chords { color: #dc3545; font-weight: bold; }
        
        .high-octave { color: var(--high-octave-color); }
        .low-octave  { color: var(--low-octave-color); }

        .sharp, .flat { font-size: 0.75em; vertical-align: super; }

        button, input[type="text"] {
            background: var(--primary-color); color: white; padding: 8px; font-size: 1.1em;
            border: 1px solid var(--light-gray); border-radius: 4px; box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
        }
        input[type="text"] {
            background: #fff; color: var(--secondary-color); text-align: center; font-weight: bold;
        }
        .tool-row button, .tool-row .radio-button, .tool-row input {
            padding: 10px 5px;
            height: 100%;
        }
        .icon { width: 1.1em; height: 1.1em; fill: currentColor; }
        body.keyboard-visible h1 { height: 0; margin: 0; opacity: 0; overflow: hidden; pointer-events: none; }

        @media (max-width: 600px) {
            #inputTextArea {
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    
    <div class="main-content">
        <h1>Transpose Live - JMS</h1>
        <div id="inputTextArea" contenteditable="true" spellcheck="false" autocorrect="off" autocapitalize="off"></div>
    </div>

    <div class="toolbar">
        <div class="contextual-controls">
            <div id="notesPanel" class="context-panel">
                <div class="tool-row" id="octave-selector-notes">
                    <div class="radio-button" data-octave="-1">Low</div>
                    <div class="radio-button selected" data-octave="0">Mid</div>
                    <div class="radio-button" data-octave="1">High</div>
                </div>
                <div class="button-scroll-wrapper"><div class="button-row" id="note-buttons-container"></div></div>
            </div>
            <div id="chordsPanel" class="context-panel">
                <div class="button-scroll-wrapper"><div class="button-row" id="chord-buttons-container"></div></div>
                <div class="button-scroll-wrapper"><div class="button-row" id="note-buttons-container-chords"></div></div>
            </div>
            <div id="toolsPanel" class="context-panel">
                <div class="tool-row">
                    <button id="transposeMinus" title="Transpose Down">-</button>
                    <input type="text" id="semitoneValue" value="0" readonly />
                    <button id="transposePlus" title="Transpose Up">+</button>
                    <div class="radio-button selected" data-value="sharp" title="Sharps">#</div>
                    <div class="radio-button" data-value="flat" title="Flats">‚ô≠</div>
                </div>
                <div class="tool-row">
                    <button id="saveBtn" title="Save"><svg class="icon" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
                    <button id="openBtn" title="Open"><svg class="icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg></button>
                    <input type="file" id="fileInput" accept=".jms" style="display: none;" />
                </div>
            </div>
        </div>
        <div class="main-nav">
            <button class="nav-btn" data-panel="notesPanel">üéµ Notes</button>
            <button class="nav-btn" data-panel="chordsPanel">üé∏ Chords</button>
            <button class="nav-btn" data-panel="toolsPanel">‚öôÔ∏è Tools</button>
        </div>
    </div>

    <script>
        // --- Element References ---
        const body = document.body;
        const inputTextArea = document.getElementById('inputTextArea');
        const semitoneValue = document.getElementById('semitoneValue');
        const noteButtonsContainer = document.getElementById('note-buttons-container');
        const noteButtonsContainerChords = document.getElementById('note-buttons-container-chords');
        const chordButtonsContainer = document.getElementById('chord-buttons-container');
        const saveBtn = document.getElementById('saveBtn');
        const openBtn = document.getElementById('openBtn');
        const fileInput = document.getElementById('fileInput');
        const mainNav = document.querySelector('.main-nav');
        const contextPanels = document.querySelectorAll('.context-panel');
        const toolsPanel = document.getElementById('toolsPanel');
        const notesPanel = document.getElementById('notesPanel');
        const chordsPanel = document.getElementById('chordsPanel'); 
        const contextualControls = document.querySelector('.contextual-controls'); 

        // --- State Variables ---
        let semitones = 0;
        let accidentalPreference = 'sharp';
        let insertionMode = 'notes';
        let currentOctave = 0; 
        let initialWindowHeight = window.innerHeight;
        
        // --- Data ---
        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes  = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const chordExtensions = ['m', 'maj7', 'm7', '7', 'dim', 'aug', 'sus4', 'sus2', '6', '9'];

        // --- Core Logic & UI ---
        function noteIndex(note) { return sharpNotes.indexOf(note) !== -1 ? sharpNotes.indexOf(note) : flatNotes.indexOf(note); }
        function transposeNote(note, shift) {
            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            const idx = noteIndex(note);
            if (idx === -1) return note;
            return notes[(idx + shift + 12) % 12];
        }
        function updateTransposition() {
            semitoneValue.value = semitones;
            inputTextArea.querySelectorAll('.music-unit').forEach(unit => {
                const originalNote = unit.dataset.originalNote;
                const originalExtension = unit.dataset.originalExtension || '';
                if (originalNote) {
                    const transposedNote = transposeNote(originalNote, semitones);
                    unit.innerHTML = formatNoteForDisplay(transposedNote) + originalExtension;
                }
            });
        }

        function formatNoteForDisplay(note) {
            if (note.length > 1) {
                const accidental = note.slice(1);
                const accidentalClass = accidental === '#' ? 'sharp' : 'flat';
                return `${note.charAt(0)}<span class="${accidentalClass}">${accidental}</span>`;
            }
            return note;
        }
        
        function renderNoteButtons(container) {
            container.innerHTML = ''; 

            const isUtilityButtonRow = container.id === 'note-buttons-container' || container.id === 'note-buttons-container-chords';

            if (isUtilityButtonRow) {
                const barBtn = document.createElement('button');
                barBtn.className = 'note-btn bar-line-btn';
                barBtn.innerHTML = '<b>|</b>';
                container.appendChild(barBtn);

                const sustainBtn = document.createElement('button');
                sustainBtn.className = 'note-btn sustain-btn';
                sustainBtn.innerHTML = '<b>.</b>';
                container.appendChild(sustainBtn);

                const pauseBtn = document.createElement('button');
                pauseBtn.className = 'note-btn pause-btn';
                pauseBtn.innerHTML = '<b>,</b>';
                container.appendChild(pauseBtn);
            }

            const notes = accidentalPreference === 'sharp' ? sharpNotes : flatNotes;
            notes.forEach(note => {
                const btn = document.createElement('button');
                btn.className = 'note-btn';
                btn.innerHTML = formatNoteForDisplay(note);
                btn.dataset.note = note;
                container.appendChild(btn);
            });

            if (isUtilityButtonRow) {
                const tags = ['CHORUS', 'VERSE', 'BRIDGE'];
                tags.forEach(tagText => {
                    const tagBtn = document.createElement('button');
                    tagBtn.className = 'note-btn tag-btn';
                    tagBtn.innerHTML = `<b>${tagText}</b>`;
                    container.appendChild(tagBtn);
                });
            }
        }

        function renderAllNoteButtons() {
            renderNoteButtons(noteButtonsContainer);
            renderNoteButtons(noteButtonsContainerChords);
        }
        function renderChordButtons() {
            chordButtonsContainer.innerHTML = '';
            chordExtensions.forEach(ext => {
                const btn = document.createElement('button');
                btn.className = 'chord-btn';
                btn.textContent = ext;
                btn.dataset.ext = ext;
                chordButtonsContainer.appendChild(btn);
            });
        }
        
        function insertMusicUnit(note, extension = '', octave = 0) {
            const selection = window.getSelection();
            if (!selection.rangeCount || !inputTextArea.contains(selection.anchorNode)) return;

            const range = selection.getRangeAt(0);
            range.deleteContents();

            const unitSpan = document.createElement('span');
            unitSpan.dataset.originalNote = note;
            unitSpan.dataset.originalExtension = extension;
            unitSpan.dataset.originalOctave = octave; 
            unitSpan.contentEditable = false;

            const classList = ['music-unit'];
            if (extension || insertionMode === 'chords') {
                classList.push('red-chords');
            } else {
                classList.push('blue-notes');
                if (octave === 1) {
                    classList.push('high-octave');
                } else if (octave === -1) {
                    classList.push('low-octave');
                }
            }
            unitSpan.className = classList.join(' ');
            
            unitSpan.innerHTML = formatNoteForDisplay(note) + extension; 
            range.insertNode(unitSpan);

            range.setStartAfter(unitSpan);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            unitSpan.scrollIntoView({ block: 'nearest', inline: 'nearest' });
        }

        function insertBarLine() {
            const selection = window.getSelection();
            if (!selection.rangeCount || !inputTextArea.contains(selection.anchorNode)) return;
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const barNode = document.createElement('b');
            barNode.className = 'bar-line';
            barNode.textContent = '|';
            range.insertNode(barNode);
            range.setStartAfter(barNode);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function insertTag(tagText) {
            document.execCommand('insertLineBreak');
            const selection = window.getSelection();
            if (!selection.rangeCount || !inputTextArea.contains(selection.anchorNode)) return;
            const range = selection.getRangeAt(0);
            const tagNode = document.createElement('b');
            tagNode.textContent = tagText;
            range.insertNode(tagNode);
            range.setStartAfter(tagNode);
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('insertLineBreak');
        }
        
        function findPrecedingMusicUnit() {
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.anchorNode) return null;
            let node = selection.anchorNode;
            let precedingNode = node.previousSibling;
            if (node.nodeType === Node.TEXT_NODE && selection.anchorOffset > 0) {
                 precedingNode = node.previousSibling;
            } else if (node.nodeType === Node.ELEMENT_NODE && selection.anchorOffset > 0) {
                 precedingNode = node.childNodes[selection.anchorOffset - 1];
            }
            while(precedingNode && precedingNode.nodeType === Node.TEXT_NODE) {
                precedingNode = precedingNode.previousSibling;
            }
            return (precedingNode && precedingNode.nodeType === Node.ELEMENT_NODE && precedingNode.classList.contains('music-unit')) ? precedingNode : null;
        }

        // --- Event Listeners ---

        function handleOctaveSelection(e) {
            const radioBtn = e.target.closest('.radio-button[data-octave]');
            if (radioBtn) {
                currentOctave = parseInt(radioBtn.dataset.octave, 10);
                notesPanel.querySelectorAll('.radio-button[data-octave]').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.octave == currentOctave);
                });
            }
        }
        notesPanel.addEventListener('click', handleOctaveSelection);

        document.getElementById('transposeMinus').addEventListener('click', () => { if (semitones > -12) semitones--; updateTransposition(); });
        document.getElementById('transposePlus').addEventListener('click', () => { if (semitones < 12) semitones++; updateTransposition(); });
        
        const universalButtonHandler = (e) => {
            const btn = e.target.closest('.note-btn');
            if (!btn) return;

            if (btn.classList.contains('bar-line-btn')) {
                insertBarLine();
            } else if (btn.classList.contains('sustain-btn')) {
                document.execCommand('insertText', false, '.');
            } else if (btn.classList.contains('pause-btn')) {
                document.execCommand('insertText', false, ',');
            } else if (btn.classList.contains('tag-btn')) {
                insertTag(btn.textContent);
            } else { // It's a note button
                insertionMode = mainNav.querySelector('.active').dataset.panel === 'chordsPanel' ? 'chords' : 'notes';
                const octaveForInsertion = insertionMode === 'chords' ? 0 : currentOctave;
                insertMusicUnit(btn.dataset.note, '', octaveForInsertion);
            }
        };
        noteButtonsContainer.addEventListener('click', universalButtonHandler);
        noteButtonsContainerChords.addEventListener('click', universalButtonHandler);


        chordButtonsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.chord-btn');
            if (!btn) return;
            const ext = btn.dataset.ext;
            let lastUnit = findPrecedingMusicUnit();
            if (lastUnit) {
                const note = lastUnit.dataset.originalNote;
                const newExt = (lastUnit.dataset.originalExtension || '') + ext;
                lastUnit.classList.remove('blue-notes', 'high-octave', 'low-octave');
                lastUnit.classList.add('red-chords');
                lastUnit.dataset.originalExtension = newExt;
                const transposedNote = transposeNote(note, semitones);
                lastUnit.innerHTML = formatNoteForDisplay(transposedNote) + newExt;
                const selection = window.getSelection();
                const range = document.createRange();
                range.setStartAfter(lastUnit);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        });
        
        toolsPanel.addEventListener('click', e => {
            const radioBtn = e.target.closest('.radio-button[data-value]');
            if (radioBtn) {
                const newValue = radioBtn.dataset.value;
                if (accidentalPreference === newValue) return;
                accidentalPreference = newValue;
                toolsPanel.querySelectorAll('.radio-button[data-value]').forEach(btn => {
                    btn.classList.remove('selected');
                });
                radioBtn.classList.add('selected');
                renderAllNoteButtons();
                updateTransposition();
            }
        });
        
        mainNav.addEventListener('click', e => {
            const targetBtn = e.target.closest('.nav-btn');
            if (!targetBtn) return;
            const targetPanelId = targetBtn.dataset.panel;
            mainNav.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            targetBtn.classList.add('active');
            contextPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetPanelId));
        });

        const preventFocusSteal = (e) => {
            if (e.target.closest('button') || e.target.closest('.radio-button') || e.target.closest('.nav-btn')) {
                e.preventDefault();
            }
        };
        toolsPanel.addEventListener('mousedown', preventFocusSteal);
        mainNav.addEventListener('mousedown', preventFocusSteal);
        chordButtonsContainer.addEventListener('mousedown', preventFocusSteal);
        notesPanel.addEventListener('mousedown', preventFocusSteal);
        chordsPanel.addEventListener('mousedown', preventFocusSteal); 
        
        inputTextArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.execCommand('insertLineBreak');
            }
        });

        // --- PASTE FUNCTIONALITY ADDED HERE ---
        inputTextArea.addEventListener('paste', (e) => {
            // Prevent the browser's default paste action.
            e.preventDefault();

            // Get the copied content as rich HTML from the clipboard.
            let pastedHtml = e.clipboardData.getData('text/html');

            // If no HTML is available, fall back to plain text.
            if (!pastedHtml) {
                const pastedText = e.clipboardData.getData('text/plain');
                document.execCommand('insertText', false, pastedText);
                return;
            }

            // Use execCommand to insert the rich HTML content at the cursor.
            // This preserves all the <span> elements, classes, and styles.
            document.execCommand('insertHTML', false, pastedHtml);
        });

        saveBtn.addEventListener('click', () => {
            const filename = prompt("Enter a name for your song:", "my-song.jms");
            if (!filename) return;
            const state = { contentHTML: inputTextArea.innerHTML, semitones: semitones };
            const fileContent = JSON.stringify(state, null, 2);
            const blob = new Blob([fileContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.endsWith('.jms') ? filename : filename + '.jms';
            a.click();
            URL.revokeObjectURL(url);
        });

        openBtn.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const state = JSON.parse(event.target.result);
                    inputTextArea.innerHTML = state.contentHTML || '';
                    semitones = state.semitones || 0;
                    semitoneValue.value = semitones;
                } catch (err) { alert("Error: Could not open the file."); }
            };
            reader.readAsText(file);
            e.target.value = null;
        });
        
        function handleKeyboardVisibility() {
            if (!window.visualViewport) return;
            if (window.visualViewport.height < initialWindowHeight * 0.9) {
                body.classList.add('keyboard-visible');
            } else {
                body.classList.remove('keyboard-visible');
                if (document.activeElement === inputTextArea) {
                    inputTextArea.blur();
                }
            }
        }
        
        window.onload = () => {
            renderAllNoteButtons();
            renderChordButtons();
            document.querySelector('.nav-btn[data-panel="notesPanel"]').click();
            if (window.visualViewport) {
                initialWindowHeight = window.innerHeight;
                window.visualViewport.addEventListener('resize', handleKeyboardVisibility);
            }
        };
    </script>
</body>
</html>
