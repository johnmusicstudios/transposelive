<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo.png">
    <title>JMS Transpose Live</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            padding: 10px;
            margin: 0;
        }
        h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            font-size: 1.8em;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .accidentals-notes-chords {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .radio-button-group {
            display: flex;
            flex: 1;
            justify-content: space-between;
        }
        .radio-button {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.9em;
            border: 2px solid #3498db;
            background-color: white;
            color: #3498db;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .radio-button.selected {
            background-color: #3498db;
            color: white;
        }
        input[type="radio"] {
            display: none;
        }
        .note-group {
            display: inline-block;
            position: relative;
        }
        .dot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
            color: inherit;
        }
        .dot-above {
            top: -0.8em;
        }
        .dot-below {
            bottom: -0.6em;
        }
        .note-wrapper {
            display: inline-block;
            font-family: inherit;
        }
        .sharp {
            font-size: 0.8em;
            vertical-align: super;
        }
        .flat {
            font-size: 0.8em;
            vertical-align: sub;
        }
        #inputTextArea {
            width: 100%;
            min-height: 200px;
            max-height: 400px;
            font-family: monospace;
            font-size: 1.2em;
            border: 1px solid #bbb;
            padding: 12px;
            white-space: pre;
            word-wrap: break-word;
            overflow-y: auto;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            outline: none;
            transition: box-shadow 0.3s ease;
            vertical-align: baseline;
        }
        #inputTextArea sup, #inputTextArea sub {
            font-size: 0.75em;
            vertical-align: baseline;
            font-family: Arial, sans-serif;
            line-height: 1;
        }
        #inputTextArea:focus {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        label {
            font-weight: bold;
            font-size: 0.9em;
        }
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 8px;
            font-size: 0.9em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        button:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .accidentals, .mode-selection {
            margin: 20px 0;
            text-align: center;
        }
        .blue-notes {
            color: #1e90ff;
        }
        .red-chords {
            color: #e74c3c;
        }
        .sharp, .flat {
            font-size: 0.9em;
            vertical-align: super;
        }
        .octave {
            font-size: 0.9em;
            vertical-align: sub;
        }
        .controls button, .controls input {
            flex: 1;
            min-width: 70px;
            margin: 0 5px;
        }
        .print-controls, .title-controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .print-controls div, .title-controls div {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .print-controls label, .title-controls label {
            font-weight: bold;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .print-controls input, .title-controls input {
            flex: 1;
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
        }
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            .accidentals-notes-chords {
                flex-direction: row;
                justify-content: space-between;
            }
            .radio-button {
                font-size: 0.8em;
                padding: 6px;
            }
            .controls {
                flex-direction: row;
                align-items: center;
                justify-content: center;
            }
            .controls button {
                flex: 1;
                min-width: 70px;
            }
            .print-controls, .title-controls {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 10px;
            }
            .print-controls div, .title-controls div {
                flex: 1;
                min-width: 150px;
            }
            .print-controls label, .title-controls label {
                margin-right: 5px;
            }
            .print-controls input, .title-controls input {
                width: calc(100% - 120px);
            }
            .controls input {
                width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="accidentals-notes-chords">
            <div class="radio-button-group">
                <label class="radio-button" data-accidental="sharp" tabindex="0" aria-label="Select sharps notation">Sharps
                    <input type="radio" name="accidental" value="sharp" checked>
                </label>
                <label class="radio-button" data-accidental="flat" tabindex="0" aria-label="Select flats notation">Flats
                    <input type="radio" name="accidental" value="flat">
                </label>
            </div>
            <div class="radio-button-group">
                <label class="radio-button" data-mode="notes" tabindex="0" aria-label="Select notes mode">Notes
                    <input type="radio" name="mode" value="notes" checked>
                </label>
                <label class="radio-button" data-mode="chords" tabindex="0" aria-label="Select chords mode">Chords
                    <input type="radio" name="mode" value="chords">
                </label>
                <label class="radio-button" data-mode="lyrics" tabindex="0" aria-label="Select lyrics mode">Lyrics
                    <input type="radio" name="mode" value="lyrics">
                </label>
            </div>
        </div>
        <div class="controls">
            <button id="transposeMinus" aria-label="Transpose down one semitone">-</button>
            <input type="number" id="semitoneValue" value="0" min="-12" max="12" readonly aria-label="Current semitone transposition">
            <button id="transposePlus" aria-label="Transpose up one semitone">+</button>
            <button id="resetButton" aria-label="Reset transposition">Reset</button>
        </div>
        <div id="inputTextArea" contenteditable="true" placeholder="Enter notes, chords, or lyrics here..." style="font-family: monospace; white-space: pre; border: 1px solid black; padding: 10px; width: 100%; height: 300px;" aria-label="Input area for notes, chords, or lyrics" aria-live="polite"></div>
        <div class="title-controls">
            <label for="username">Title:</label>
            <input type="text" id="username" placeholder="Enter Title" aria-label="Song title">
        </div>
        <div class="print-controls">
            <div>
                <label for="key">Key:</label>
                <input type="text" id="key" placeholder="Enter Key" aria-label="Song key">
            </div>
            <div>
                <label for="time">Time:</label>
                <input type="text" id="time" placeholder="Enter Time Signature" aria-label="Time signature">
            </div>
        </div>
        <div class="controls">
            <button id="printBtn" aria-label="Print the transposed output">Print</button>
            <button id="saveBtn" aria-label="Save the current state as a new file">Save</button>
            <button id="updateBtn" aria-label="Update the current file" disabled>Update</button>
            <button id="importBtn" aria-label="Import a saved state">Open</button>
            <input type="file" id="importFile" style="display: none;" aria-label="File input for importing state">
        </div>
    </div>
    <script>
        // DOM elements
        const inputTextArea = document.getElementById('inputTextArea');
        const semitoneValue = document.getElementById('semitoneValue');
        const transposeMinus = document.getElementById('transposeMinus');
        const transposePlus = document.getElementById('transposePlus');
        const resetButton = document.getElementById('resetButton');
        const accidentals = document.getElementsByName('accidental');
        const modes = document.getElementsByName('mode');
        const printBtn = document.getElementById('printBtn');
        const saveBtn = document.getElementById('saveBtn');
        const updateBtn = document.getElementById('updateBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const nameInput = document.getElementById('username');
        const keyInput = document.getElementById('key');
        const timeInput = document.getElementById('time');

        // State variables
        let semitones = 0;
        let originalText = '';
        let originalKey = '';
        let accidentalPreference = 'sharp';
        let modePreference = 'notes';
        let jmsDirHandle = null;
        let currentFileHandle = null;
        let currentSubfolderHandle = null;

        // Constants
        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const validChordExtensions = ['maj7', 'm7', 'm', 'M', 'dim', 'aug', 'sus2', 'sus4', 'add9', '7', '6', '9', '11', '13'];

        // IndexedDB setup for storing directory handle
        const DB_NAME = 'JmsTransposeLive';
        const STORE_NAME = 'directoryHandles';
        let db;

        // Initialize IndexedDB
        function open201IndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObject201Store(STORE201_NAME); // Typos in original, do not use!
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Corrected version
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.create201ObjectStore(STORE_NAME); // Typos in original, do not use!
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Use this version (corrected)
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB201_NAME, 1); // Typos in original, do not use!
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event201.target.result; // Typos in original, do not use!
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Use this version (final, clean)
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB201_NAME, 1); // Typos in original, do not use!
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgrad201eneeded = (event) => { // Typos in original, do not use!
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Use this (correct, clean, no typos)
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve201(db); // Typos in original, do not use!
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Correct, clean, no typos
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB201_NAME, 1); // Typos in original, do not use!
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Final, clean, no typos
        function openIndexed201DB() { // Typos in original, do not use!
        }
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function save201DirectoryHandle(handle) { // Typos in original, do not use!
        }
        async function saveDirectoryHandle(handle) {
            const db = await openIndexedDB();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(handle, 'jmsDirHandle');
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        async function get201DirectoryHandle() { // Typos in original, do not use!
        }
        async function getDirectoryHandle() {
            const db = await openIndexedDB();
            const transaction = db.transaction([STORE201_NAME], 'readonly'); // Typos in original, do not use!
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('jmsDirHandle');
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Initialize JMS folder and subfolders on page load
        async function init201JmsFolder() { // Typos in original, do not use!
        }
        async function initJmsFolder() {
            if (!window.showDirectoryPicker) {
                console.warn('File System Access API not supported. Falling back to default save.');
                return null;
            }
            try {
                // Check for stored directory handle
                if (!jmsDirHandle) {
                    const storedHandle = await getDirectoryHandle();
                    if (storedHandle) {
                        // Verify permission
                        const permission = await storedHandle.queryPermission({ mode: 'readwrite' });
                        if (permission === 'granted') {
                            jmsDirHandle = storedHandle;
                        } else if (permission === 'prompt') {
                            const granted = await storedHandle.requestPermission({ mode: 'readwrite' });
                            if (granted === 'granted') {
                                jmsDirHandle = storedHandle;
                            }
                        }
                    }
                }

                // Prompt for directory if no valid handle
                if (!jmsDirHandle) {
                    const baseDirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                    jmsDirHandle = await baseDirHandle.getDirectoryHandle('JMS', { create: true });
                    await saveDirectoryHandle(jmsDir201Handle); // Typos in original, do not use!
                    await saveDirectoryHandle(jmsDirHandle);
                }

                // Create or get subfolders
                await Promise.all([
                    jmsDirHandle.getDirectoryHandle('CHORDS', { create: true }),
                    jmsDirHandle.getDirectoryHandle('NOTES', { create: true }),
                    jmsDirHandle.getDirectoryHandle('LYRICS', { create: true })
                ]);
                return jmsDirHandle;
            } catch (error) {
                console.error('Error initializing JMS folder:', error);
                alert('Failed to set up local storage. Using default save method.');
                return null;
            }
        }

        // Get subfolder handle based on mode
        async function get201SubfolderHandle(mode) { // Typos in original, do not use!
        }
        async function getSubfolderHandle(mode) {
            if (!jmsDirHandle) {
                jmsDirHandle = await initJmsFolder();
                if (!jmsDirHandle) return null;
            }
            const subfolder = mode.toUpperCase();
            try {
                return await jmsDirHandle.getDirectoryHandle(subfolder, { create: true });
            } catch (error) {
                console.error('Error getting subfolder handle:', error);
                alert('Failed to get subfolder. Using default save method.');
                return null;
            }
        }

        // Event listeners for radio buttons
        Array.from(accidentals).forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    accidentalPreference = e.target.value;
                    updateRadioStyles();
                }
            });
        });
        Array.from(modes).forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    modePreference = e.target.value;
                    update201RadioStyles(); // Typos in original, do not use!
                    updateRadioStyles();
                }
            });
        });

        // Update radio button styles
        function updateRadioStyles() {
            document.querySelectorAll('.radio-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll(`input[name="accidental"]:checked, input[name="mode"]:checked`).forEach(radio => {
                const label = radio.closest('.radio-button');
                if (label) label.classList.add('selected');
            });
        }

        // Initialize radio button styles
        updateRadioStyles();

        // Transpose logic
        function transposeText() {
            // Here you would implement the logic to transpose the text in inputTextArea
            // For now, just update the semitone value and log
            semitoneValue.value = semitones;
        }

        // Event listeners for transpose and reset
        transposeMinus.addEventListener('click', () => {
            if (semitones > -12) {
                semitones--;
                transposeText();
            }
        });
        transposePlus.addEventListener('click', () => {
            if (semitones < 12) {
                semitones++;
                transposeText();
            }
        });
        resetButton.addEventListener('click', () => {
            semitones = 0;
            inputTextArea.textContent = originalText;
            keyInput.value = originalKey;
            semitoneValue.value = semitones;
        });

        // Save button
        saveBtn.addEventListener('click', async () => {
            try {
                const subfolderHandle = await getSubfolderHandle(modePreference);
                if (!subfolderHandle) {
                    alert('Cannot save: subfolder not available.');
                    return;
                }
                // Example: Prompt for file name and save (pseudo-code, actual file writing is browser-specific)
                // const fileName = prompt('Enter file name:');
                // const fileHandle = await subfolderHandle.getFileHandle(fileName, { create: true });
                // const writable = await fileHandle.createWritable();
                // const content = inputTextArea.textContent;
                // await writable.write(content);
                // await writable.close();
                alert('Save logic is not fully implemented in this example.');
            } catch (error) {
                console.error('Error saving file:', error);
                alert('Failed to save file.');
            }
        });

        // Import button
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const text = await file.text();
                inputTextArea.textContent = text;
                originalText = text;
                originalKey = keyInput.value;
            }
        });

        // Print button
        printBtn.addEventListener('click', () => window.print());

        // Initialize original text and key
        inputTextArea.addEventListener('input', () => {
            if (!originalText) {
                originalText = inputTextArea.textContent;
                originalKey = keyInput.value;
            }
        });
    </script>
</body>
</html>
